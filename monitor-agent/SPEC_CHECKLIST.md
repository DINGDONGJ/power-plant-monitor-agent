# Monitor-Agent 需求规格对照表

## 一、功能需求（Must）

### 1) 目标进程监控

| 需求 | 状态 | 说明 |
|------|------|------|
| 支持按 PID 指定监控目标 | ✅ | `-pid` 参数 |
| 支持按进程名指定监控目标 | ✅ | `-name` 参数 |
| 能判断目标进程是否存活 | ✅ | `IsAlive()` + `alive` 字段 |
| 目标进程找不到时记录状态与事件（不崩溃） | ❌ | 当前启动时找不到会直接退出 |

### 2) 周期采集指标

| 需求 | 状态 | 说明 |
|------|------|------|
| 固定周期采样（默认 1s） | ✅ | `time.Ticker` 1秒 |
| 采样周期可配置 | ❌ | 当前硬编码 1s |
| 采集 CPU 使用率 | ✅ | `cpu_pct` |
| 采集内存占用（RSS） | ✅ | `rss_bytes` |
| 采集存活状态 | ✅ | `alive` |
| 每条采样带时间戳 | ✅ | `timestamp` |
| 每条采样带 PID | ✅ | `pid` |
| 采样来源/错误信息 | ❌ | 未实现 |

### 3) 规则判定

| 需求 | 状态 | 说明 |
|------|------|------|
| 进程退出触发判定 | ✅ | `checkRules()` 检测 `!alive` |
| CPU 连续超阈值触发判定 | ✅ | `cpuExceedCnt` 计数器 |
| 阈值可配置 | ✅ | `-cpu-threshold` |
| 持续次数可配置 | ✅ | `-cpu-exceed-count` |
| 规则可开关 | ❌ | 当前无开关，阈值设 0 可变相关闭 |

### 4) 处置动作（自愈）

| 需求 | 状态 | 说明 |
|------|------|------|
| 支持执行重启命令 | ✅ | `-restart-cmd` |
| 冷却时间 cooldown | ✅ | 10秒冷却（硬编码） |
| cooldown 可配置 | ❌ | 当前硬编码 10s |
| 频率限制（每小时最多 N 次） | ❌ | 未实现 |
| 处置结果记录（成功/失败） | ⚠️ | 仅记录触发，未记录执行结果/返回码 |

### 5) 对外 HTTP 查询

| 需求 | 状态 | 说明 |
|------|------|------|
| GET /health | ✅ | 返回 `{"status": "ok"}` |
| GET /status | ✅ | 当前状态 + 最近采样 + 配置 |
| GET /status 含规则状态 | ❌ | 未返回规则触发状态 |
| GET /status 含最近处置 | ❌ | 未返回最近处置信息 |
| GET /metrics/recent | ✅ | `?n=` 参数，按条数 |
| GET /metrics/recent 按秒数 | ❌ | 当前按条数，非秒数 |
| GET /events/recent | ✅ | `?n=` 参数 |

### 6) 事件与日志

| 需求 | 状态 | 说明 |
|------|------|------|
| 记录 samples（指标点） | ✅ | JSONL 落盘 |
| 记录 events（规则触发、处置） | ✅ | JSONL 落盘 |
| 重启链路可追溯 | ⚠️ | 有事件序列，但缺少关联 ID |

### 7) 跨平台要求

| 需求 | 状态 | 说明 |
|------|------|------|
| 业务逻辑 Windows/Linux 共用 | ✅ | `monitor/` 包 |
| OS 差异封装在适配层 | ✅ | `provider/` 接口 + build tags |
| Windows 可编译运行 | ✅ | 已验证 |
| Linux 可编译运行 | ✅ | 代码支持，未实际验证 |

---

## 二、非功能需求（Must）

### 1) 稳定性

| 需求 | 状态 | 说明 |
|------|------|------|
| 采集失败不退出 | ✅ | 错误被捕获，继续下一轮 |
| 目标不存在不退出 | ❌ | 启动时找不到会退出 |
| 采集错误降级处理 | ⚠️ | 记录但未标记错误类型 |

### 2) 性能

| 需求 | 状态 | 说明 |
|------|------|------|
| 默认采样频率 1s | ✅ | |
| 开销可控 | ✅ | 仅查询单个 PID |
| Ring Buffer 存储指标 | ✅ | 泛型 `RingBuffer[T]` |
| 保存最近 10 分钟 | ❌ | 当前默认 60 条（1分钟） |

### 3) 安全/权限

| 需求 | 状态 | 说明 |
|------|------|------|
| HTTP 默认只读 | ✅ | 无写入接口 |
| 留鉴权扩展点 | ❌ | 未预留 |
| 重启命令仅来自本地配置 | ✅ | 命令行参数指定 |

---

## 三、可选需求（Should / Nice to have）

| 需求 | 状态 | 说明 |
|------|------|------|
| A) POST /actions/restart 手动触发 | ❌ | |
| A) 简单 token 防误用 | ❌ | |
| B) 心跳超时判断卡死 | ❌ | |
| C) JSONL → SQLite | ❌ | |
| C) 滚动/清理策略 | ❌ | |
| D) Linux systemd unit | ❌ | |
| D) Windows 服务安装脚本 | ❌ | |
| E) 网络指标 per-PID | ❌ | |

---

## 四、验收用例

| 用例 | 状态 | 说明 |
|------|------|------|
| agent 启动后 /health 返回 ok | ✅ | |
| 启动目标进程，/status 显示 alive=true | ✅ | |
| kill 目标进程，自动拉起 | ✅ | |
| events 中出现 exit/restart 事件 | ✅ | |
| CPU 持续超阈值后触发 restart | ✅ | |
| cooldown 生效（事件中体现） | ✅ | 日志显示 `restart skipped` |
| 每小时上限生效 | ❌ | 未实现频率限制 |

---

## 统计

| 类别 | 已实现 | 部分实现 | 未实现 |
|------|--------|----------|--------|
| 功能需求（Must） | 18 | 2 | 9 |
| 非功能需求（Must） | 5 | 1 | 3 |
| 可选需求 | 0 | 0 | 8 |
| 验收用例 | 6 | 0 | 1 |

**总体完成度：约 65%**（作为 Demo 核心功能已覆盖）
